# üîß Comprehensive Troubleshooting Guide

## üö® Common Installation Issues

### Python Environment Problems

#### Issue: `python: command not found`
```bash
# Problem: Python not installed or not in PATH
# Solution: Install Python 3.12+
# On macOS:
brew install python@3.12
# On Ubuntu/Debian:
sudo apt update && sudo apt install python3.12
# On Windows: Download from python.org
```

#### Issue: `ModuleNotFoundError: No module named 'module_name'`
```bash
# Problem: Dependencies not installed or virtual environment not activated
# Solution 1: Activate virtual environment
source .venv/bin/activate  # On macOS/Linux
.venv\Scripts\activate     # On Windows

# Solution 2: Reinstall dependencies
pip install --upgrade pip
pip install -r requirements.txt

# Solution 3: Verify Python version
python --version  # Should be 3.12+
which python      # Should point to .venv/bin/python
```

#### Issue: `playwright install chromium` fails
```bash
# Problem: Playwright browser installation failed
# Solution 1: Install with dependencies
playwright install-deps chromium
playwright install chromium

# Solution 2: Manual installation
pip uninstall playwright
pip install playwright
playwright install chromium

# Solution 3: Use system browser (fallback)
# Edit html_to_pdf_converter.py to use WeasyPrint instead
```

---

## üîë API Key Configuration Issues

### Environment Variable Problems

#### Issue: `API key not found` errors
```bash
# Problem: .env file not created or API keys missing
# Solution 1: Verify .env file exists
ls -la .env
cat .env  # Should show your API keys

# Solution 2: Copy from template
cp .env.example .env
# Edit .env with actual API keys

# Solution 3: Check format
# Correct format:
OPENAI_API_KEY=sk-your_key_here
ANTHROPIC_API_KEY=sk-ant-your_key_here
# No spaces around =, no quotes needed
```

#### Issue: `Invalid API key format` warnings
```bash
# Problem: Incorrect API key format
# Solution: Verify key formats
# OpenAI keys: start with 'sk-'
# Anthropic keys: start with 'sk-ant-'

# Test key format
echo $OPENAI_API_KEY | cut -c1-3     # Should show 'sk-'
echo $ANTHROPIC_API_KEY | cut -c1-7  # Should show 'sk-ant'
```

#### Issue: `python-dotenv not loading .env`
```bash
# Problem: Environment variables not loading
# Solution 1: Install python-dotenv
pip install python-dotenv

# Solution 2: Manual environment variables
export OPENAI_API_KEY="your-key-here"
export ANTHROPIC_API_KEY="your-key-here"

# Solution 3: Check file location
# .env must be in project root directory
pwd  # Should be in BookProcessor/
ls .env  # Should exist here
```

---

## üìÑ PDF Processing Issues

### TOC Detection Problems

#### Issue: `No chapters found in Table of Contents`
```bash
# Problem: TOC not detected or in unsupported format
# Diagnosis: Check PDF structure manually
python -c "
import pdfplumber
with pdfplumber.open('books/your-book.pdf') as pdf:
    for i, page in enumerate(pdf.pages[:10]):
        text = page.extract_text()
        if 'chapter' in text.lower() or 'contents' in text.lower():
            print(f'Page {i+1}: Found TOC keywords')
            print(text[:500])
"

# Solution 1: Try different PDF
# Some PDFs have image-based TOCs that can't be parsed

# Solution 2: Manual chapter list
# Create manual chapter mapping if TOC parsing fails

# Solution 3: Check verbose output
python book_processor.py "books/your-book.pdf" --verbose
# Look for TOC detection messages
```

#### Issue: `Chapter pages detected` but extraction fails
```bash
# Problem: Page numbers don't match actual chapters
# Diagnosis: Verify detected pages
python book_processor.py "books/your-book.pdf" --verbose
# Check "STEP 2: Scanning for chapter pages..." output

# Solution 1: Check PDF page numbering
# Some PDFs have offset page numbers (cover pages, etc.)

# Solution 2: Verify chapter markers
# Look for consistent "CHAPTER X" patterns in the PDF

# Solution 3: Try different detection patterns
# Some books use "Chapter 1" vs "CHAPTER 1" formatting
```

### PDF Extraction Errors

#### Issue: `Error extracting chapter: Permission denied`
```bash
# Problem: PDF is password protected or corrupted
# Solution 1: Remove password protection
# Use PDF tools to unlock the file first

# Solution 2: Check file permissions
chmod 644 books/your-book.pdf
ls -la books/your-book.pdf

# Solution 3: Try different PDF reader
# Test with different PDF processing library
```

#### Issue: `PyPDF2.errors.PdfReadError`
```bash
# Problem: Corrupted or malformed PDF
# Solution 1: Try pdfplumber fallback
# The system automatically tries pdfplumber if PyPDF2 fails

# Solution 2: Repair PDF
# Use online PDF repair tools or:
gs -o repaired.pdf -sDEVICE=pdfwrite -dPDFSETTINGS=/prepress original.pdf

# Solution 3: Re-download source PDF
# File may have been corrupted during download
```

---

## üìö EPUB Processing Issues

### EPUB Structure Problems

#### Issue: `No chapters found in EPUB`
```bash
# Problem: EPUB structure not recognized
# Diagnosis: Check EPUB contents
python -c "
import zipfile
with zipfile.ZipFile('books/your-book.epub', 'r') as epub:
    for name in epub.namelist()[:20]:
        print(name)
"

# Solution 1: Verify EPUB format
# File should have .epub extension and be a valid ZIP

# Solution 2: Check content length threshold
# Very short sections (< 500 chars) are skipped
# Reduce threshold in epub_processor.py if needed

# Solution 3: Manual inspection
unzip -l books/your-book.epub | grep -i html
```

#### Issue: `Images missing from PDF output`
```bash
# Problem: Image extraction failed
# Diagnosis: Check for images in EPUB
python -c "
import zipfile
with zipfile.ZipFile('books/your-book.epub', 'r') as epub:
    images = [f for f in epub.namelist() if f.endswith(('.png', '.jpg', '.jpeg', '.gif'))]
    print(f'Found {len(images)} images')
    for img in images[:5]:
        print(img)
"

# Solution 1: Check image formats
# Only PNG, JPG, JPEG, GIF are supported

# Solution 2: Verify image extraction
# Look for Chapter_XX_images folders during processing

# Solution 3: Check HTML content
# Images must be referenced in HTML with <img> tags
```

### HTML‚ÜíPDF Conversion Issues

#### Issue: `Playwright conversion failed`
```bash
# Problem: Playwright/Chromium not working
# Solution 1: Install Chromium browser
playwright install chromium

# Solution 2: Check system dependencies
# On Ubuntu/Debian:
sudo apt-get install -y libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libxss1 libasound2

# Solution 3: Use WeasyPrint fallback
# System automatically tries WeasyPrint if Playwright fails

# Solution 4: Check permissions
# Ensure write access to output directory
```

#### Issue: `WeasyPrint dependencies missing`
```bash
# Problem: WeasyPrint system dependencies not installed
# Solution (macOS):
brew install pango gdk-pixbuf libffi

# Solution (Ubuntu/Debian):
sudo apt-get install build-essential python3-dev python3-pip python3-setuptools python3-wheel python3-cffi libcairo2 libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0 libffi-dev shared-mime-info

# Alternative: Stick with Playwright only
# Remove WeasyPrint from requirements.txt if not needed
```

---

## ü§ñ AI Summarization Issues

### API Connection Problems

#### Issue: `OpenAI API error: Authentication failed`
```bash
# Problem: Invalid or expired API key
# Solution 1: Verify API key
curl -H "Authorization: Bearer $OPENAI_API_KEY" https://api.openai.com/v1/models
# Should return list of models

# Solution 2: Check API key permissions
# Ensure key has access to GPT-4o model

# Solution 3: Verify billing
# Check OpenAI dashboard for billing status
```

#### Issue: `Claude API error: 401 Unauthorized`
```bash
# Problem: Invalid Anthropic API key
# Solution 1: Test API key
curl -H "Authorization: Bearer $ANTHROPIC_API_KEY" -H "Content-Type: application/json" https://api.anthropic.com/v1/messages -d '{"model":"claude-3-5-sonnet-20241022","max_tokens":10,"messages":[{"role":"user","content":"test"}]}'

# Solution 2: Check key format
# Anthropic keys should start with 'sk-ant-'

# Solution 3: Verify account status
# Check Anthropic console for account status
```

### Content Processing Issues

#### Issue: `Content too large for context window`
```bash
# Problem: Chapter text exceeds LLM context limits
# Diagnosis: Check content length
python -c "
from AI_summarizer.pdf_text_extractor import extract_text_from_pdf
text = extract_text_from_pdf('path/to/large-chapter.pdf')
print(f'Characters: {len(text)}')
print(f'Estimated tokens: {len(text) // 4}')
"

# Solution 1: Split large chapters manually
# Use PDF tools to break into smaller sections

# Solution 2: Increase context limits
# Use GPT-4-turbo or Claude with larger context windows

# Solution 3: Truncate content
# Modify check_content_length() to truncate instead of reject
```

#### Issue: `PDF text extraction returns empty content`
```bash
# Problem: PDF contains images/scanned text
# Diagnosis: Check PDF type
python -c "
from AI_summarizer.pdf_text_extractor import extract_text_from_pdf
text = extract_text_from_pdf('path/to/chapter.pdf')
print(f'Extracted {len(text)} characters')
print('First 200 chars:', text[:200])
"

# Solution 1: Use OCR-enabled PDF processing
# Convert scanned PDFs to text-searchable format

# Solution 2: Try different extraction method
# Modify pdf_text_extractor.py to try additional libraries

# Solution 3: Manual text input
# For important chapters, manually type key content
```

---

## üóÇÔ∏è File Organization Issues

### Directory Structure Problems

#### Issue: `Permission denied creating directories`
```bash
# Problem: Insufficient write permissions
# Solution 1: Check permissions
ls -la book_chapters/
# Should show writable directories

# Solution 2: Fix permissions
chmod 755 book_chapters/
chmod 755 .

# Solution 3: Change output location
python book_processor.py "books/book.pdf" --output "/tmp/test_output" --verbose
```

#### Issue: `Filename too long` errors
```bash
# Problem: Chapter titles create long filenames
# Diagnosis: Check filename lengths
find book_chapters/ -name "*.pdf" -exec basename {} \; | while read name; do echo "${#name} $name"; done | sort -n

# Solution 1: Modify sanitize_filename() in utils.py
# Reduce maximum filename length

# Solution 2: Shorten chapter titles
# Edit title cleaning logic in processors

# Solution 3: Use shorter output directory path
python book_processor.py "books/book.pdf" --output "out" --verbose
```

### Missing Files Problems

#### Issue: `Some chapters missing from output`
```bash
# Problem: Extraction failed for some chapters
# Diagnosis: Check processing report
python -c "
import json
with open('book_chapters/book-name_chapters/book-name_processing_report.json') as f:
    report = json.load(f)
    print(f'Expected: {report[\"book_info\"][\"total_chapters\"]}')
    print(f'Created: {len(report[\"extracted_files\"])}')
"

# Solution 1: Check verbose output for errors
python book_processor.py "books/book.pdf" --verbose
# Look for "‚ùå Failed:" messages

# Solution 2: Verify page ranges
# Some chapters may have invalid page ranges

# Solution 3: Manual verification
# Check if chapters exist in source PDF at expected pages
```

---

## üîß Performance & Resource Issues

### Memory Problems

#### Issue: `MemoryError` during processing
```bash
# Problem: Insufficient memory for large files
# Solution 1: Increase system memory
# Add swap space or upgrade RAM

# Solution 2: Process smaller files
# Split large PDFs before processing

# Solution 3: Monitor memory usage
top -p $(pgrep -f book_processor.py)
# Check memory consumption during processing
```

#### Issue: Slow processing performance
```bash
# Problem: Processing takes too long
# Diagnosis: Profile processing time
time python book_processor.py "books/book.pdf" --verbose

# Solution 1: Use SSD storage
# Move books/ and output directories to SSD

# Solution 2: Close other applications
# Free up system resources

# Solution 3: Process in batches
# Avoid processing multiple large books simultaneously
```

### Disk Space Issues

#### Issue: `No space left on device`
```bash
# Problem: Insufficient disk space
# Diagnosis: Check disk usage
df -h
du -sh book_chapters/

# Solution 1: Clean up old outputs
rm -rf book_chapters/old-book_chapters/
find book_chapters/ -name "*_images" -type d -exec rm -rf {} +

# Solution 2: Use different output location
python book_processor.py "books/book.pdf" --output "/path/to/larger/drive" --verbose

# Solution 3: Compress old files
tar -czf archive.tar.gz book_chapters/old-books/
rm -rf book_chapters/old-books/
```

---

## üö® Emergency Recovery Procedures

### Corrupted Output Recovery
```bash
# If processing output becomes corrupted
# 1. Stop all running processes
pkill -f book_processor.py
pkill -f chatgpt_summarizer.py
pkill -f claude_summarizer.py

# 2. Remove corrupted output
rm -rf book_chapters/corrupted-book_chapters/

# 3. Restart with clean slate
python book_processor.py "books/book.pdf" --output "book_chapters" --verbose
```

### Lost .env File Recovery
```bash
# If .env file is accidentally deleted
# 1. Recreate from template
cp .env.example .env

# 2. Re-enter API keys
# Get keys from OpenAI and Anthropic dashboards

# 3. Test configuration
python -c "
import os
from dotenv import load_dotenv
load_dotenv()
print('OpenAI:', 'OK' if os.getenv('OPENAI_API_KEY') else 'Missing')
print('Claude:', 'OK' if os.getenv('ANTHROPIC_API_KEY') else 'Missing')
"
```

### System-Wide Reset
```bash
# Complete system reset if everything breaks
# 1. Backup important data
cp -r book_chapters/ backup_book_chapters/
cp .env .env.backup

# 2. Clean virtual environment
deactivate
rm -rf .venv/

# 3. Reinstall everything
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
playwright install chromium

# 4. Restore configuration
cp .env.backup .env

# 5. Test basic functionality
python book_processor.py --help
```

This troubleshooting guide covers the most common issues users encounter when setting up and using the Book Summarizer system.